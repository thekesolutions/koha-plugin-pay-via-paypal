name: CI
on:
  push:
  pull_request:
    branches:
      - main

jobs:
  unit_tests:
    name: Run unit tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        koha-version: [main, stable, oldstable]

    steps:
    - name: Checkout plugin code
      uses: actions/checkout@v4

    - name: Get Koha Version Branch Name
      id: koha-version
      uses: "bywatersolutions/github-action-koha-get-version-by-label@v2"
      with:
        version-label: "${{ matrix.koha-version }}"

    - name: Set up environment variables
      run: |
        IFS='/' read -r -a parts <<< "$GITHUB_REPOSITORY"
        GITHUB_REPO="${parts[1]}"
        echo "GITHUB_REPO=$GITHUB_REPO" >> $GITHUB_ENV
        echo "KOHA_BRANCH=${{ steps.koha-version.outputs.current-branch-name }}" >> $GITHUB_ENV
        echo "PLUGINS_DIR=$(pwd)/.." >> $GITHUB_ENV
        echo "SYNC_REPO=$(pwd)/../kohaclone" >> $GITHUB_ENV

    - name: Check out Koha
      run: |
        cd ..
        git clone --branch ${{ env.KOHA_BRANCH }} --single-branch --depth 1 https://github.com/Koha-Community/Koha.git kohaclone

    - name: Install koha-testing-docker
      run: |
        cd ..
        git clone https://gitlab.com/koha-community/koha-testing-docker.git
        cd koha-testing-docker
        cp env/defaults.env .env
        echo "$(pwd)/bin" >> $GITHUB_PATH

    - name: Launch KTD instance with plugins support
      run: |
        cd ../koha-testing-docker
        export LOCAL_USER_ID=$(id -u)
        export KTD_HOME=$(pwd)
        if [ "${{ matrix.koha-version }}" = "main" ]; then
          export KOHA_IMAGE=main
        else
          export KOHA_IMAGE=${{ steps.koha-version.outputs.version-major-minor }}
        fi
        ktd --name paypaltest --plugins up -d

    - name: Wait for KTD to be ready
      run: |
        cd ../koha-testing-docker
        export KTD_HOME=$(pwd)
        ktd --name paypaltest --wait-ready 120

    - name: Install plugins in KTD
      run: |
        export KTD_HOME=$(pwd)/../koha-testing-docker
        ktd --name paypaltest --shell --run "cd /kohadevbox/koha && perl misc/devel/install_plugins.pl"

    - name: Run plugin tests
      run: |
        export KTD_HOME=$(pwd)/../koha-testing-docker
        ktd --name paypaltest --shell --run "
          cd /kohadevbox/plugins/${{ env.GITHUB_REPO }} &&
          sudo cpanm --notest TAP::Harness::JUnit &&
          JUNIT_OUTPUT_FILE=junit.xml prove -v -r -s t/ --harness=TAP::Harness::JUnit
        "

    - name: Publish test results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: junit.xml
        check_name: "Test Results (Koha ${{ matrix.koha-version }})"

    - name: Show logs on failure
      if: failure()
      run: |
        export KTD_HOME=$(pwd)/../koha-testing-docker
        echo "=== KTD instance status ==="
        ktd --name paypaltest --list || true
        echo "=== Koha error logs ==="
        ktd --name paypaltest --shell --run "tail -50 /var/log/koha/kohadev/plack-intranet-error.log" || true
        echo "=== Container logs ==="
        docker logs paypaltest-koha-1 --tail 50 || true

    - name: Cleanup KTD instance
      if: always()
      run: |
        export KTD_HOME=$(pwd)/../koha-testing-docker
        ktd --name paypaltest down || true

  release:
    name: Build & Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: unit_tests
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Koha Plugin kpz artifact
        id: kpz
        run: |
          docker run -v ${PWD}:/plugin registry.gitlab.com/thekesolutions/tools/koha-plugin-builder
          echo "filename=$(ls *.kpz)" >> $GITHUB_OUTPUT
      
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.kpz.outputs.filename }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
